<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Redirecting to ForFuture...</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      margin: 0;
      background: linear-gradient(135deg, #0A0B1F 0%, #1a1b3a 100%);
      color: #fff;
      padding: 20px;
    }
    .container {
      text-align: center;
      max-width: 500px;
      background: rgba(255, 255, 255, 0.1);
      padding: 40px;
      border-radius: 20px;
      backdrop-filter: blur(10px);
    }
    h1 {
      margin: 0 0 20px 0;
      font-size: 24px;
      color: #00F2FE;
    }
    p {
      margin: 15px 0;
      line-height: 1.6;
      color: rgba(255, 255, 255, 0.8);
    }
    .link {
      display: inline-block;
      margin: 20px 0;
      padding: 12px 24px;
      background: rgba(0, 242, 254, 0.3);
      border: 1px solid #00F2FE;
      border-radius: 8px;
      color: #00F2FE;
      text-decoration: none;
      font-weight: bold;
      word-break: break-all;
    }
    .link:hover {
      background: rgba(0, 242, 254, 0.5);
    }
    .error {
      color: #ff6b6b;
      display: none;
    }
    .instructions {
      display: none;
      margin-top: 30px;
    }
    .instructions.show {
      display: block;
    }
    .spinner {
      border: 3px solid rgba(0, 242, 254, 0.3);
      border-top: 3px solid #00F2FE;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 20px auto;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    code {
      background: rgba(0, 0, 0, 0.3);
      padding: 10px;
      border-radius: 5px;
      display: block;
      margin: 10px 0;
      font-size: 12px;
      word-break: break-all;
      color: #00F2FE;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Redirecting to ForFuture...</h1>
    <div class="spinner"></div>
    <p>Please wait while we open the app...</p>
    
    <div id="instructions" class="instructions">
      <p><strong>If the app didn't open automatically:</strong></p>
      <p>1. Make sure the ForFuture app is installed on your device</p>
      <p>2. Tap the link below to open the app manually:</p>
      <a href="#" id="app-link" class="link">Tap to Open ForFuture App</a>
      <p style="margin-top: 20px; font-size: 14px; color: rgba(255, 255, 255, 0.6);">
        Or copy this URL and open it in the app:
      </p>
      <code id="app-url"></code>
    </div>
    
    <div id="error" class="error">
      <p><strong>Invalid or Expired Link</strong></p>
      <p>The password reset link is invalid or has expired. Please request a new password reset link.</p>
    </div>
  </div>

  <script>
    (function() {
      // Get the full URL with hash
      const hash = window.location.hash;
      const search = window.location.search;
      
      // Check if we have a token in hash (from Supabase redirect)
      // Supabase may redirect to root (/) with hash, or to this page with hash
      let token = null;
      let appUrl = null;
      
      if (hash.includes('access_token=')) {
        // Extract token from hash (Supabase puts it in hash)
        const match = hash.match(/access_token=([^&]+)/);
        token = match ? match[1] : null;
        
        if (token) {
          // Build app deep link with full hash (includes access_token, expires_at, etc.)
          appUrl = `forfuture://auth/reset-password${hash}`;
        }
      } else if (search.includes('access_token=')) {
        // Alternative: token in query string
        const match = search.match(/[?&]access_token=([^&]+)/);
        token = match ? match[1] : null;
        
        if (token) {
          // Build app deep link with token
          appUrl = `forfuture://auth/reset-password#access_token=${token}`;
        }
      } else if (search.includes('token=')) {
        // Alternative: token in query string (if Supabase sends it that way)
        const params = new URLSearchParams(search);
        token = params.get('token');
        const redirectTo = params.get('redirect_to');
        
        if (token && redirectTo) {
          // If redirect_to is our app scheme, use it
          if (redirectTo.startsWith('forfuture://')) {
            appUrl = `${redirectTo}#access_token=${token}`;
          }
        }
      }
      
      if (appUrl) {
        // Set the link for manual tap
        document.getElementById('app-link').href = appUrl;
        document.getElementById('app-url').textContent = appUrl;
        
        // Try to open app immediately
        window.location.href = appUrl;
        
        // If app doesn't open in 2 seconds, show instructions
        setTimeout(() => {
          document.getElementById('instructions').classList.add('show');
          document.querySelector('.spinner').style.display = 'none';
          document.querySelector('p').textContent = 'Tap the link below to open the app:';
        }, 2000);
      } else {
        // No valid token found
        document.getElementById('error').style.display = 'block';
        document.querySelector('.spinner').style.display = 'none';
        document.querySelector('p').style.display = 'none';
      }
      
      // Also try to open app on click anywhere (fallback)
      document.addEventListener('click', function(e) {
        if (appUrl && !e.target.closest('#app-link')) {
          window.location.href = appUrl;
        }
      }, { once: true });
    })();
  </script>
</body>
</html>

