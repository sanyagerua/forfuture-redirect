<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Redirecting to ForFuture...</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      margin: 0;
      background: linear-gradient(135deg, #0A0B1F 0%, #1a1b3a 100%);
      color: #fff;
      padding: 20px;
    }
    .container {
      text-align: center;
      max-width: 500px;
      background: rgba(255, 255, 255, 0.1);
      padding: 40px;
      border-radius: 20px;
      backdrop-filter: blur(10px);
    }
    h1 {
      margin: 0 0 20px 0;
      font-size: 24px;
      color: #00F2FE;
    }
    p {
      margin: 15px 0;
      line-height: 1.6;
      color: rgba(255, 255, 255, 0.8);
    }
    .link {
      display: inline-block;
      margin: 20px 0;
      padding: 16px 32px;
      background: rgba(0, 242, 254, 0.3);
      border: 2px solid #00F2FE;
      border-radius: 12px;
      color: #00F2FE;
      text-decoration: none;
      font-weight: bold;
      font-size: 18px;
      word-break: break-all;
      cursor: pointer;
      transition: all 0.3s ease;
      -webkit-tap-highlight-color: rgba(0, 242, 254, 0.5);
    }
    .link:hover,
    .link:active {
      background: rgba(0, 242, 254, 0.5);
      transform: scale(1.05);
    }
    .error {
      color: #ff6b6b;
      display: none;
    }
    .instructions {
      display: none;
      margin-top: 30px;
    }
    .instructions.show {
      display: block;
    }
    .spinner {
      border: 3px solid rgba(0, 242, 254, 0.3);
      border-top: 3px solid #00F2FE;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 20px auto;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    code {
      background: rgba(0, 0, 0, 0.3);
      padding: 10px;
      border-radius: 5px;
      display: block;
      margin: 10px 0;
      font-size: 12px;
      word-break: break-all;
      color: #00F2FE;
    }
    .copy-btn {
      position: absolute;
      top: 0;
      right: 0;
      padding: 8px 16px;
      background: rgba(0, 242, 254, 0.3);
      border: 1px solid #00F2FE;
      border-radius: 8px;
      color: #00F2FE;
      font-size: 14px;
      font-weight: bold;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 5px;
      transition: all 0.3s ease;
      -webkit-tap-highlight-color: rgba(0, 242, 254, 0.5);
    }
    .copy-btn:hover,
    .copy-btn:active {
      background: rgba(0, 242, 254, 0.5);
      transform: scale(1.05);
    }
    .copy-btn.copied {
      background: rgba(76, 175, 80, 0.3);
      border-color: #4CAF50;
      color: #4CAF50;
    }
    #copy-icon {
      font-size: 16px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Redirecting to ForFuture...</h1>
    <div class="spinner"></div>
    <p>Please wait while we open the app...</p>
    
    <div id="instructions" class="instructions">
      <p><strong>If the app didn't open automatically:</strong></p>
      <p>1. Make sure the ForFuture app is installed on your device</p>
      <p>2. Tap the link below to open the app manually:</p>
      <a href="#" id="app-link" class="link">Tap to Open ForFuture App</a>
      <p style="margin-top: 20px; font-size: 14px; color: rgba(255, 255, 255, 0.6);">
        <strong>For iOS Safari:</strong> Copy the URL below and paste it in Safari's address bar:
      </p>
      <div style="position: relative; margin: 15px 0; background: rgba(0, 0, 0, 0.2); padding: 10px; border-radius: 8px;">
        <code id="app-url" style="margin-bottom: 10px; padding-right: 70px; display: block; word-break: break-all;"></code>
        <button id="copy-button" class="copy-btn" onclick="copyToClipboard()" title="Copy link">
          <span id="copy-icon">ðŸ“‹</span>
          <span id="copy-text">Copy</span>
        </button>
      </div>
      <p style="margin-top: 10px; font-size: 12px; color: rgba(255, 255, 255, 0.5);">
        After copying, open Safari â†’ Tap address bar â†’ Paste â†’ Press Go
      </p>
    </div>
    
    <div id="error" class="error">
      <p><strong>Invalid or Expired Link</strong></p>
      <p>The password reset link is invalid or has expired. Please request a new password reset link.</p>
    </div>
  </div>

  <script>
    (function() {
      // Get the full URL with hash
      const hash = window.location.hash;
      const search = window.location.search;
      
      // Check if we have a token in hash (from Supabase redirect)
      // Supabase may redirect to root (/) with hash, or to this page with hash
      let token = null;
      let appUrl = null;
      
      if (hash.includes('access_token=')) {
        // Extract token from hash (Supabase puts it in hash)
        const match = hash.match(/access_token=([^&]+)/);
        token = match ? match[1] : null;
        
        if (token) {
          // Build app deep link with full hash (includes access_token, expires_at, etc.)
          appUrl = `forfuture://auth/reset-password${hash}`;
        }
      } else if (search.includes('access_token=')) {
        // Alternative: token in query string
        const match = search.match(/[?&]access_token=([^&]+)/);
        token = match ? match[1] : null;
        
        if (token) {
          // Build app deep link with token
          appUrl = `forfuture://auth/reset-password#access_token=${token}`;
        }
      } else if (search.includes('token=')) {
        // Alternative: token in query string (if Supabase sends it that way)
        const params = new URLSearchParams(search);
        token = params.get('token');
        const redirectTo = params.get('redirect_to');
        
        if (token && redirectTo) {
          // If redirect_to is our app scheme, use it
          if (redirectTo.startsWith('forfuture://')) {
            appUrl = `${redirectTo}#access_token=${token}`;
          }
        }
      }
      
      if (appUrl) {
        // Set the link for manual tap
        const linkEl = document.getElementById('app-link');
        const urlEl = document.getElementById('app-url');
        if (linkEl) linkEl.href = appUrl;
        if (urlEl) urlEl.textContent = appUrl;
        
        // Show instructions immediately (Safari blocks automatic redirects)
        document.getElementById('instructions').classList.add('show');
        document.querySelector('.spinner').style.display = 'none';
        document.querySelector('p').textContent = 'Tap the link below to open the app:';
        
        // Try automatic redirect on iOS Safari (may not work due to security restrictions)
        // Use window.location.replace for better compatibility
        try {
          // For iOS Safari, we need user interaction, but try anyway
          window.location.replace(appUrl);
        } catch (e) {
          // Fallback if replace fails
          console.log('Automatic redirect failed, showing manual link');
        }
        
        // Also try opening via iframe trick (iOS Safari workaround)
        setTimeout(() => {
          try {
            const iframe = document.createElement('iframe');
            iframe.style.display = 'none';
            iframe.src = appUrl;
            document.body.appendChild(iframe);
            setTimeout(() => {
              document.body.removeChild(iframe);
            }, 1000);
          } catch (e) {
            // Ignore errors
          }
        }, 500);
      } else {
        // No valid token found
        document.getElementById('error').style.display = 'block';
        document.querySelector('.spinner').style.display = 'none';
        document.querySelector('p').style.display = 'none';
      }
      
      // Make entire page clickable as fallback
      document.addEventListener('click', function(e) {
        if (appUrl) {
          // Only redirect if clicking on page itself (not on the link button or copy button)
          if (e.target === document.body || e.target.closest('.container')) {
            window.location.href = appUrl;
          }
        }
      }, { once: true });
    })();

    // Copy to clipboard function
    function copyToClipboard() {
      const appUrl = document.getElementById('app-url').textContent;
      const copyButton = document.getElementById('copy-button');
      const copyText = document.getElementById('copy-text');
      const copyIcon = document.getElementById('copy-icon');
      
      if (!appUrl) {
        alert('No URL to copy. Please wait for the page to load.');
        return;
      }
      
      // Try modern clipboard API first
      if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(appUrl).then(function() {
          // Success
          copyButton.classList.add('copied');
          copyIcon.textContent = 'âœ…';
          copyText.textContent = 'Copied!';
          
          setTimeout(function() {
            copyButton.classList.remove('copied');
            copyIcon.textContent = 'ðŸ“‹';
            copyText.textContent = 'Copy';
          }, 2000);
        }).catch(function(err) {
          // Fallback to manual copy
          fallbackCopyToClipboard(appUrl);
        });
      } else {
        // Fallback for older browsers
        fallbackCopyToClipboard(appUrl);
      }
    }
    
    // Fallback copy method for older browsers
    function fallbackCopyToClipboard(text) {
      const textArea = document.createElement('textarea');
      textArea.value = text;
      textArea.style.position = 'fixed';
      textArea.style.top = '-9999px';
      textArea.style.left = '-9999px';
      document.body.appendChild(textArea);
      textArea.focus();
      textArea.select();
      
      try {
        const successful = document.execCommand('copy');
        if (successful) {
          const copyButton = document.getElementById('copy-button');
          const copyText = document.getElementById('copy-text');
          const copyIcon = document.getElementById('copy-icon');
          
          copyButton.classList.add('copied');
          copyIcon.textContent = 'âœ…';
          copyText.textContent = 'Copied!';
          
          setTimeout(function() {
            copyButton.classList.remove('copied');
            copyIcon.textContent = 'ðŸ“‹';
            copyText.textContent = 'Copy';
          }, 2000);
        } else {
          alert('Failed to copy. Please manually select and copy the URL.');
        }
      } catch (err) {
        alert('Failed to copy. Please manually select and copy the URL.');
      } finally {
        document.body.removeChild(textArea);
      }
    }
  </script>
</body>
</html>

